---
title: "Estudio de las variaciones residenciales en España en 2021"
subtitle: Análisis Exploratorio de Datos
author: Javier Hinarejos & Samuel Ortega
date: 13-11-2023
output:
  ioslides_presentation:
    number_sections: true
    widescreen: true
    logo: logo.jpg
    smaller: true
    df_print: paged
---

```{css style-opts, echo=FALSE}

.title-slide hgroup h1 {
  font-size: 50px;
  letter-spacing: 1px;
}

.gdbar img {
  width: 500px !important;
  height: 100px !important;
  margin: 8px 8px;
}

.gdbar {
  width: 550px !important;
  height: 120px !important;
}

slides > slide:not(.nobackground):before {
  width: 300px;
  height: 60px;
  background-size: 300px 60px;
}

css selector {
font-size: 12px;
}
```

```{r setup, include=FALSE}
base::options(width = 50, digits = 3)
knitr::opts_chunk$set(echo = F, message = T, error = F, warning = F, comment = NA, dpi = 100, tidy = T, cache.path = '.cache/', fig.path = './figure/', include = T)

if (!require(pacman)) {
  install.packages("pacman")
  library(pacman)
}
pacman::p_load(imager, readxl, kableExtra)
```

```{r dependencies, include=FALSE}
source("ProyectoAED2023_library.R")
load(file = "./data_for_slides/data.RData")
load(file = "./data_for_slides/data_map.RData")
load(file = "./data_for_slides/outliers.RData")
load(file = "./data_for_slides/chi.RData")
load(file = "./data_for_slides/full_df.RData")
```

# Inspección de los datos

## Obtención de los datos {#obt-datos}

<style>
  #obt-datos > p {      
    margin-top: -30px;     
  }
</style>
  
Base de microdatos del INE:

 - Variaciones residenciales (2021): [https://go.uv.es/saorme/ine-var-res-2021](https://go.uv.es/saorme/ine-var-res-2021).
 - Diccionario de municipios (2021): [https://go.uv.es/saorme/ine-muni-2021](https://go.uv.es/saorme/ine-muni-2021).

```{r ine-img, fig.height = 4, fig.align="center"}
img <- load.image("./figure/ine.png")
par(mar = c(0, 0, 1, 0))
plot(img, axes = FALSE)
```

## Previsualización del fichero principal

La información está almacenada en el fichero en filas de longitud fija.

<font size="1">
```{r preview}
raw_data_preview <- readLines('./data/md_EVR_2021.txt', n = 3)
preview_df <- data.frame(linea = 1:length(raw_data_preview), contenido = raw_data_preview)
preview_df
```
</font>

Interpretamos la información con el fichero de metadatos.

<font size="1">
```{r metadatos}
excel_dict_file <- "./data/dr_EVR_2021.xlsx"
metadata <- read_excel(excel_dict_file, sheet = "Diseño",
                         range = "A2:J19", col_names = TRUE)

metadata
```
</font>

# Preprocesado

## Comprobación de longitud y separación en variables

 - Comprobar la longitud de las entradas crudas.
 
 - Separar por variables.

<font size="1">
```{r}
raw_data_df
```
</font>

## Obtención de los diccionarios

A continuación, extraemos de los ficheros adicionales la información necesaria para interpretar los códigos de los datos crudos. Generamos dos variables:

<div class="columns-2">

 - `dict_list`: resumen de metadatos de los diccionarios.
 
<font size="1">
```{r}
dict_list[5]
```
</font>
 
 - `dict_info`: diccionario completo con todos los códigos y descripciones.
 
<font size="1">
```{r}
dict_info
```
</font>
 
</div>

## Aplicación de diccionarios y cambio de clase {#apply-dict}

<style>
  #apply-dict > p {      
    margin-top: -20px;     
  }
</style>

Aplicamos los diccionarios y convertimos las variables para al formato adecuado, indicado en los metadatos. Figuran dos tipos: N (numérico) -> `numeric` y A (alfanumérico) -> `factor`.
 
Creamos nuevas variables categóricas: **COMUBAJA**, **COMUALTA**, **COMUNAC**.

<font size="1">
```{r data_df}
data_df
```
</font>

<font size="1">
```{r nas}
na_summary
```
</font>

# Análisis estadístico

## Resumen del dataset {#res}

<style>
  #res > p {      
    margin-top: -30px;     
  }
</style>

Exploramos la información esencial y el tipo de cada variable para confirmar que estén en el formato adecuado empleando la función `str()`.

<font size="1">
```{r str-data}
str(data_df)
```
</font>

Eliminamos las siguientes variables de nuestro conjunto de datos: **MESNAC**, **ANOVAR**, **MESVAR**.
 
## Datos faltantes {#nas}

<style>
  #nas > p {      
    margin-top: -20px;     
  }
</style>

Si realizamos un `summary()`, podemos observamos que las variables de municipio y tamaño contienen numerosos valores faltantes. En algunas de las variables categóricas, aparecen niveles cuyo significado es equivalente a un dato faltante de cara al análisis: "No Consta", "(Other)", "Baja por Caducidad".

```{r}
plot_file <- "./figure/summary.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

## Análisis Univariante: Numéricas

```{r, fig.align = 'center'}
plot_file <- "./figure/boxplot_edad.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

## Análisis Univariante: Numéricas

<div class="columns-2">

```{r, fig.width = 5, fig.height = 4}
plot_file <- "./figure/descdist_edad.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

```{r, fig.width = 5, fig.height = 4}
plot_file <- "./figure/descdist_mesvar.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

</div>

## Aproximación normal

```{r qqplot, fig.align = 'center'}
plot_file <- "./figure/qqplot_edad.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

## Movimiento entre comunidades

```{r, fig.align = 'center'}
plot_file <- "./figure/barplot_diffs.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

## Análisis bivariante: Numérica - Numérica

La variable **ANONAC** debería tener una gran correlación con la variable **EDAD**.

```{r bivar-anonac-edad1, fig.align = 'center'}
plot_file <- "./figure/pairs_anonac_edad.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

$EDAD = 2021 - ANONAC$

## Análisis bivariante: Numéricas - Categóricas

```{r hist-num-cat, fig.align = 'center'}
plot_file <- "./figure/hist_edad_sexo.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

## Análisis bivariante: Numéricas - Categóricas

```{r boxplot-sexo, fig.align = 'center', , fig.width = 4, fig.height = 2.5}
mujeres <- filter(data_df, SEXO == "Mujer")
hombres <- filter(data_df, SEXO=='Hombre')
t.test(mujeres$EDAD,hombres$EDAD)
plot_file <- "./figure/boxplot_edad_sexo.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

## Análisis bivariante: Categóricas - Categóricas {#cat-cat1}

<style>
  #cat-cat1 > p {      
    margin-top: -20px;     
  }
</style>

Para seguir con el estudio del éxodo rural, podemos representar la relación entre el tamaño de los municipios de alta y de baja en un mosaico. Por limpieza, hemos recodificado las categorías de tamaño de la siguiente manera.

```{r, fig.align = 'center'}
plot_file <- "./figure/mosaic_tamu.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

## Análisis bivariante: Categóricas - Categóricas {#cat-cat2}

<style>
  #cat-cat2 > p {      
    margin-top: -20px;     
  }
</style>

Para complementar este análisis, transformamos nuestros datos a fin de obtener un `data.frame` con la siguiente estructura:

 - **MUNI**: contiene todos los valores únicos de las variables **MUNIALTA** y **MUNIBAJA**.

 - **TAMU**: valor correspondiente de **TAMUALTA** / **TAMUBAJA**.
 
 - **isCAPITAL**: valor lógico que indica si el municipio es capital.
 
 - **EDAD**: media de la edad de los desplazados desde ó hasta cada municipio.
 
 - **MES**: moda del mes en el que se producen los movimientos desde ó hasta cada municipio.
 
 - **nBAJAS**: número de bajas en cada municipio.
 
 - **nALTAS**: número de bajas en cada municipio.
 
Las variables adicionales **nTOTAL** y **nNETO** son la suma y la diferencia de las últimas dos variables listadas.

## Análisis bivariante: Categóricas - Categóricas {#cat-cat3}

<div class="columns-2">

```{r, fig.width = 5, fig.height = 4}
plot_file <- "./figure/boxplot_tamu.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

```{r, fig.width = 5, fig.height = 4}
plot_file <- "./figure/boxplot_capital.jpg"
img <- load.image(plot_file)
par(mar = c(0, 0, 0, 0))
plot(img, axes = FALSE)
```

</div>

## Análisis interactivo: mapas

```{r plot-mapa, message = F, fig.align = 'center'}
residence_variations_map <- plot_residence_variation_map(prov_data, dict_prov, selected_prov)
residence_variations_map
```

## Características

Se usa el test Chi-cuadrado. Este test supone una hipótesis de partida $H_0$ (Son independientes) y dependiendo del resultado del
test, se acepta o no:

p<0.05: Rechazamos hipótesis
p \(\geq\) 0.05: Aceptamos Ho

Lo aplicamos a las variables **COMUALTA** y **COMUBAJA**.

```{r chisq-comu}
print(chitest1)
```

## Análisis de outliers

Realizamos un análisis de la variable numérica **EDAD** de los outliers.

```{r}
outliers
```

 - Los métodos percentil (5%-95%), 3-sigma y boxplot asumen que la distribución es gaussiana. 3-sigma es el menos exigente.
 - El método hampel no asume distribución gaussiana.
 
# Conclusiones

## Conclusiones

Podemos afirmar que, durante el año 2021 en España, las variaciones residenciales no presentaron ninguna dependencia significativa con la época del año. Por otra parte, sí observamos que la edad es un factor importante en cuanto al cambio de residencia: hay un máximo absoluto en torno a los 35 años, que es coherente con la edad de independización definitiva de muchas familias. También concluimos que esta relación no es independiente del sexo.

La tasa de migración de España con el extranjero durante el año estudiado es positiva y de valor elevado. Sin embargo, este resultado puede estar influido por la amplia cantidad de variaciones de salida codificadas como "Baja por Caducidad".

Por último, observamos que gran cantidad de las variaciones residenciales se producen entre municipios pequeños, pero no suponen un desplazamiento neto elevado. No obstante, en las ciudades más grandes la tasa neta de variaciones residenciales es mucho más grande, lo cual es un indicio del proceso de centralización actual.

En conclusión, hemos logrado importar, procesar, interpretar y analizar el dataset propuesto. Para ello, hemos hecho uso de numerosas funciones y librerías que nos han permitido realizar este proyecto de manera eficiente y obtener las conclusiones descritas.
