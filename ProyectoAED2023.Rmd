---
title: Proyecto Análisis Exploratorio de Datos 2023
author:
  - name: Javier Hinarejos Albero
    affil: 1, \dagger
  - name: Samuel Ortega Mediavilla
    affil: 1, \dagger, *
affiliation:
  - num: 1
    address: |
      Universitat de València - 
      Escuela Técnica Superior de Ingeniería
      Avenida de la Universitat s/n 46100 Burjassot. Valencia. España
# author citation list in chicago format
authorcitation: |
  Hinarejos, J.; Ortega, S.
# firstnote to eighthnote
firstnote: |
  These authors contributed equally to this work.
correspondence: |
  saorme@alumni.uv.es.
# document options
journal: notspecified
type: article
status: submit
# front matter
simplesummary: |
  A Simple summary goes here.
abstract: |
  A single paragraph of about 200 words maximum. For research articles, 
  abstracts should give a pertinent overview of the work. We strongly encourage
  authors to use the following style of structured abstracts, but without 
  headings: 1) Background: Place the question addressed in a broad context and
  highlight the purpose of the study; 2) Methods: Describe briefly the main
  methods or treatments applied; 3) Results: Summarize the article's main 
  findings; and 4) Conclusion: Indicate the main conclusions or interpretations. 
  The abstract should be an objective representation of the article, it must not 
  contain results which are not presented and substantiated in the main text and 
  should not exaggerate the main conclusions.
# back matter
keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).
acknowledgement: |
  All sources of funding of the study should be disclosed. Please clearly 
  indicate grants that you have received in support of your research work. 
  Clearly state if you received funds for covering the costs to publish in open 
  access.
authorcontributions: |
  For research articles with several authors, a short paragraph specifying their 
  individual contributions must be provided. The following statements should be 
  used ``X.X. and Y.Y. conceive and designed the experiments; X.X. performed the 
  experiments; X.X. and Y.Y. analyzed the data; W.W. contributed 
  reagents/materials/analysis tools; Y.Y. wrote the paper.'' Authorship must be
  limited to those who have contributed substantially to the work reported.
funding: |
  This research received no external funding.
institutionalreview: |
  In this section, you should add the Institutional Review Board Statement and 
  approval number, if relevant to your study. You might choose to exclude 
  this statement if the study did not require ethical approval. Please note 
  that the Editorial Office might ask you for further information. Please add 
  “The study was conducted in accordance with the Declaration of Helsinki, 
  and approved by the Institutional Review Board (or Ethics Committee) of 
  NAME OF INSTITUTE (protocol code XXX and date of approval).” for studies 
  involving humans. OR “The animal study protocol was approved by the 
  Institutional Review Board (or Ethics Committee) of NAME OF INSTITUTE 
  (protocol code XXX and date of approval).” for studies involving animals. 
  OR “Ethical review and approval were waived for this study due to REASON 
  (please provide a detailed justification).” OR “Not applicable” for
   studies not involving humans or animals.
informedconsent: |
  Any research article describing a study involving humans should contain this 
  statement. Please add ``Informed consent was obtained from all subjects 
  involved in the study.'' OR ``Patient consent was waived due to REASON 
  (please provide a detailed justification).'' OR ``Not applicable'' for 
  studies not involving humans. You might also choose to exclude this statement 
  if the study did not involve humans.
  
  Written informed consent for publication must be obtained from participating 
  patients who can be identified (including by the patients themselves). Please 
  state ``Written informed consent has been obtained from the patient(s) to 
  publish this paper'' if applicable.
dataavailability: |
  We encourage all authors of articles published in MDPI journals to share 
  their research data. In this section, please provide details regarding where 
  data supporting reported results can be found, including links to publicly 
  archived datasets analyzed or generated during the study. Where no new data 
  were created, or where data is unavailable due to privacy or ethical 
  re-strictions, a statement is still required. Suggested Data Availability 
  Statements are available in section “MDPI Research Data Policies” at 
  \url{https://www.mdpi.com/ethics}.
conflictsofinterest: |
  Declare conflicts of interest or state 'The authors declare no conflict of 
  interest.' Authors must identify and declare any personal circumstances or
  interest that may be perceived as inappropriately influencing the
  representation or interpretation of reported research results. Any role of the
  funding sponsors in the design of the study; in the collection, analyses or 
  interpretation of data in the writing of the manuscript, or in the decision to 
  publish the results must be declared in this section. If there is no role, 
  please state 'The founding sponsors had no role in the design of the study; 
  in the collection, analyses, or interpretation of data; in the writing of the 
  manuscript, an in the decision to publish the results'.
sampleavailability: |
  Samples of the compounds ...... are available from the authors.
supplementary: |
 The following supporting information can be downloaded at:  
 \linksupplementary{s1}, Figure S1: title; Table S1: title; Video S1: title.
abbreviations:
  - short: INE
    long: Instituto Nacional de Estadística
bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---

```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}
# Configuración general de chunks
if (!require(knitr)) {
  install.packages("knitr")
  library(knitr)
}
base::options(width = 50, digits = 3)
knitr::opts_chunk$set(echo = T, message = T, error = F, warning = F, comment = NA, dpi = 100, tidy = T, cache.path = '.cache/', fig.path = './figure/', include = T)
```

```{r packages, message = T, include = T, echo = T}
# Carga de paquetes necesarios con pacman
if (!require(pacman)) {
  install.packages("pacman")
  library(pacman)
}
pacman::p_load(kableExtra, readxl, stringr, tidyr, dplyr, ggmap, leaflet, leaflet.extras2, sf, colorspace, car, fitdistrplus, ggmosaic)
```

# Datos seleccionados

Hemos escogido los datos de variaciones residenciales en 2021 del INE. Estos datos están disponibles en el siguiente enlace: [https://go.uv.es/saorme/ine-var-res-2021](https://go.uv.es/saorme/ine-var-res-2021).

Adicionalmente, hemos empleado la relación de municipios de 2021, disponible en: [https://go.uv.es/saorme/ine-muni-2021](https://go.uv.es/saorme/ine-muni-2021).

# Previsualización de los datos

En el fichero principal de datos `md_EVR_2021.txt`, observamos que cada registro contiene una cadena de caracteres de longitud fija. Su interpretación viene detallada en el fichero adicional de metadatos `dr_EVR_2021.xlsx`.

```{r preview}
raw_data_preview <- readLines('./data/md_EVR_2021.txt', n = 3)
kable(raw_data_preview)
```

# Lectura de funciones

Las funciones definidas para el procesado de este dataset están disponibles en el fichero `ProyectoAED2023_library.R`.

```{r def-functions}
prev_objects <- ls()
source("ProyectoAED2023_library.R")
new_objects <- ls()
loaded_functions <- new_objects[!(new_objects %in% prev_objects)]
cat("Funciones cargadas:", loaded_functions, sep = "\n")
```

# Lectura de los ficheros

En primer lugar, leemos la información de todos los ficheros necesarios.

```{r load-files}
data_file <- "./data/md_EVR_2021.txt"
excel_dict_file <- "./data/dr_EVR_2021.xlsx"
main_sheet <- "Diseño"
municipios_file <- "./data/diccionario21.xlsx"

raw_data <- readLines(data_file, encoding = "UTF-8")

vars_table <- read_excel(excel_dict_file, sheet = main_sheet,
                         range = "A2:J19", col_names = TRUE)
```

# Preprocesado

## Limpieza de longitud incorrecta

Como primera comprobación, nos aseguramos de que todas las entradas de los datos crudos tienen la longitud adecuada, definida en los metadatos.

```{r check-length}
entry_length <- vars_table$Longitud[vars_table$Variable == "TOTAL"]

filtered_raw_data <- raw_data[nchar(raw_data) == entry_length]

# No necesitamos la última entrada para nada más
vars_table <- vars_table[vars_table$Variable != "TOTAL", ]
```

## Creación del dataframe

Dividimos los datos en un `data.frame` a partir de las posiciones y longitudes definidas en los metadatos.

```{r split-data}
raw_data_df <- split_raw_data(filtered_raw_data, vars_table)
```

## Obtención de los diccionarios

A continuación, extraemos de los ficheros adicionales la información necesaria para interpretar los códigos de los datos crudos.

```{r get-dicts}
sheet_list <- load_excel_dicts(excel_dict_file)
municipios_data <- read_excel(municipios_file, skip = 1,
                                  col_names = TRUE)

dict_list <- create_dict_list(vars_table)
dict_info <- get_dict_from_sheets(dict_list, sheet_list, municipios_data)
```

## Interpretación de los códigos de las variables

Una vez obtenidos los diccionarios, los aplicamos a los datos crudos divididos.

```{r apply-dicts}
data_df <- apply_dict_to_data(raw_data_df, dict_info, dict_list)
```

Adicionalmente, verificamos que la interpretación se ha realizado correctamente. Para ello, buscamos los valores no disponibles en el nuevo `data.frame` y comprobamos si proceden de códigos mal interpretados o, por el contrario, corresponden a entradas en blanco.

```{r check-na}
na_summary <- check_na_procedence(raw_data_df, data_df)

kable(na_summary)
```

A continuación, vamos a cambiar el tipo de las variables para tenerlas en el formato adecuado indicado en los metadatos.

```{r convert-num}
data_df <- convert_numeric_vars(data_df, vars_table)
```


## Análisis univariante

```{r}
summary(data_df)
```
```{r}
str(data_df)
```
### Eliminar variables
Tras observar las diferentes variables del conjunto de datos, decidimos eliminar aquellas variables que no aportan información valiosa en nuestro conjunto de datos.

```{r}
elim <- c('MESNAC', 'ANONAC', 'ANOVAR')

data_df <- data_df[, !(names(data_df) %in% elim)]
```

Decidimos eliminar las variables:

MESNAC: Consideramos que no aporta valor el mes de nacimiento de una persona.
ANONAC: Es una variable duplicada, ya que aporta la misma información que la edad de las personas.
ANOVAR: Todos los datos provienen del año 2021.

Otra variable que es posible que no sea de mucho interés es MESVAR, pero de momento decidimos no eliminarla para estudiar si existe alguna época del año en la cual las personas decidan cambiar de residencia con mayor frecuencia.
```{r}
# Análisis variables numericas

numer<- data_df %>%
  select_if(is.numeric)

print(numer)

boxplot(numer$EDAD)
table(numer$MESVAR)

descdist(numer$EDAD)
descdist(numer$MESVAR)
```

Mediante los gráficos de Cullen y Frey observamos que la variable MESVAR la podemos aproximar mediante una función uniforme. Por tanto, podemos eliminarla también ya que no aporta valor a nuestro conjunto de datos. Si tuviésemos datos de más años podríamos calcular la serie temporal y observar si hay alguna relación entre mudarse y el mes de cambio de residencia. Por otra parte, la variable Edad nos indica que se puede ajustar bajo una distribución gamma, lo cual tiene sentido, ya que la mediana es 35.7 y sin embargo, alcanza valores de hasta 111 años. Esto es debido a que la mayor parte de la gente se muda alrededor de la treintena y una vez ya han conseguido un trabajo y una familia estable, la decisión de cambiar de residencia es cada vez más complicada.

```{r}
elim <- c('MESVAR')

data_df <- data_df[, !(names(data_df) %in% elim)]
```

A pesar de ser una distribución gamma, mediante la función qqPlot vemos si se puede aproximar también mediante una distribución normal.

```{r}
library(car)
qqPlot(data_df$EDAD, distribution = "norm")
```

## Análisis univariante( Variables Categóricas)

```{r}
table(data_df$PROVALTA)
```

Si analizamos todas las provincias o municipios, tenemos muchos niveles dentro del factor, así que vamos a intentar obtener información más relevante a través del estudio de las comunidades autónomas.
Seguidamente, utilizando la librería ggplot vamos a representar un histograma de edades por sexo, ya que queremos conocer la edad a la cual la gente suele cambiar de residencia y si existe alguna diferencia significativa entre hombres y mujeres a la hora de tomar esta decisión.

```{r}
histograma <- ggplot(data_df, aes(x=EDAD, fill=SEXO)) +
  geom_histogram(binwidth=5, position="dodge") +
  labs(
    title="Histograma de Edades por Sexo",
    x="Edad",
    y="Frecuencia"
  ) +
  scale_fill_manual(values=c("Hombre"="blue", "Mujer"="pink"))
print(histograma)
```

Tras observar esta gráfica, se observa que la gente cambia más de residencia alrededor de los 30 años, lo cual tiene sentido, ya que es la etapa de la vida en la que muchas personas deciden independizarse o formar una nueva familia.

Si queremos estudiar ambas colas, un detalle importante a tener en cuenta y que está apoyado científicamente es que las mujeres viven más de media que los hombres y lo podemos observar a edades tardías, ya que hay una diferencia significativa entre hombres y mujeres a esa edad. Por otra parte, también se observa que tras el nacimiento de los hijos o en muchas ocasiones del segundo hijo de la pareja, las familias suelen tomar la decisión de mudarse a un hogar más amplio.


Tras analizar según las edades y el sexo, planteamos otra cuestión de vital importancia como es el hecho de estudiar el éxodo rural.

```{r}
bajas <- table(data_df$PROVBAJA)
altas <- table(data_df$PROVALTA)

#Comprobamos si el número de altas es el mismo número que de bajas para poder realizar la comparación correctamente
sum(bajas)==sum(altas)

var_provincias <- altas - bajas

print(var_provincias)
```
El dato más significativo que se observa es que España es un país con un mayor número de inmigrantes que de emigrantes y por consecuencia, la población en las diferentes provincias españolas aumenta. Además, otro dato curioso es que no se observa un decrecimiento en las provincias del interior de España "La España despoblada". A continuación, estudiaremos el flujo migratorio según el tamaño de los municipios para valorar el éxodo rural.

Para ello, podemos representar la relación entre el tamaño de los municipios de alta y de baja en un mosaico. Por limpieza, hemos recodificado las categorías de tamaño de la siguiente manera:

| Código en el mosaico | Descripción |
| -:- | -:- |
| tam_1 | Municipio no capital hasta 10.000 habitantes |
| tam_2 | Municipio no capital de 10.001 a 20.000 |
| tam_3 | Municipio no capital de 20.001 a 50.000 |
| tam_4 | Municipio no capital de 50.001 a 100.000 |
| ntam_5 | Municipio no capital  de más de 100.000 |
| capital | Municipio capital de provincia |

```{r mosaic-tamu}
mosaic_df <- data_df[
  complete.cases(data_df[c("SEXO", "TAMUALTA", "TAMUBAJA")]),]

levels(mosaic_df$TAMUBAJA) <- c(paste0("tam_", 1:5), "capital")
levels(mosaic_df$TAMUALTA) <- c(paste0("tam_", 1:5), "capital")

ggplot(mosaic_df) +
  geom_mosaic(aes(
    x = product(TAMUALTA, TAMUBAJA),
    fill = TAMUALTA)) +
  geom_mosaic_text(
    aes(
      x = product(TAMUALTA, TAMUBAJA),
      label = after_stat(.wt)),
    as.label = TRUE) +
  labs(
    title = "Mosaic Plot of TAMUALTA and TAMUBAJA",
    x = "TAMUBAJA",
    y = "TAMUALTA") +
  theme_minimal() +
  guides(fill = "none")
```

```{r plot-prov}
dict_prov <- get_prov_location(fileDir = "./data/prov_locations.RData")

selected_prov <- "Palencia"
prov_data <- get_net_prov_movements(data_df, selected_prov)
residence_variations_map <- plot_residence_variation_map(prov_data, dict_prov, selected_prov)
residence_variations_map
```



